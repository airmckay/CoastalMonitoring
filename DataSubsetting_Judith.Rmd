---
title: "DataSubsetting_Judith"
output: html_document
date: "2025-08-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Prepare and overview automatically classified bat acoustic data for Judith Feldhaus's Masters thesis. 

## Import the full dataset from Maris of all the 2024 CM observations combined and subset for Judith's sites

## THen try to further subset based on the measures that Maris and I agreed on 

Check all categories: 
VMUR, NNOC, PAUR, BBAR
 
Check 50% 
Myotis all together
 
Check 10%
PPYG, PNAT
 
Check 5% 
EPNI
 
NoID and Noise subset - block number per site. Will determine exact value later.

Subset by site by month within year
 
Aim for approximately 12500 recordings per site
 
6 sites in total 
Sites: CM-04, CM-06, CM-05, CM-23, CM-21, CM-42
 


## Prepare workspace
```{r}
library(data.table)
library(tidyverse)
library(beepr)
library(lubridate)
library(purrr)
library(janitor)
library(renv)
library(stringr)
library(beepr)
library(randomcoloR)
library(wesanderson)
library(leaflegend)
library(osmdata)
library(MetBrewer)
library(colorBlindness)
library(colorblindcheck)
library(MoMaColors)

getwd()
# "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/GitHubLink/CoastalMonitoring/CoastalMonitoring"

## Setup output directory 
output <-"C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/CoastalMonitoring/Analyses/Outputs/Reed" # where you want to save your data

file.name <- "OverviewProcessedBatData_Judith2025"

todays_date <- Sys.Date()
 
dir.name <- str_c(output,"/", file.name, "_", todays_date)
dir.name
 
output_today <- dir.name
output_today

dir.create(output_today)
output_today
# "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/CoastalMonitoring/Analyses/Outputs/Reed/OverviewProcessedBatData_Judith2025_2025-08-12"

```

## Subset and tidy the dataset for only Judith's sites
Sites: CM-04, CM-06, CM-05, CM-23, CM-21, CM-42

```{r}
input <- read_csv("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/CoastalMonitoring/Analyses/Outputs/2024 data/cm_all.csv")

dim(input)
# 3554546      12

## Housekeeping
df1 <- input %>% 
  mutate(autoid = factor(autoid), 
         site = factor(Site)) %>% 
  dplyr::select(FOLDER, filename, 
                DATE, TIME, HOUR,
                DATE.12, TIME.12, HOUR.12,
                autoid, site
                ) %>% 
  dplyr::filter(site %in% c("CM-04", "CM-06", 
                            "CM-05", "CM-23",
                            "CM-21", "CM-42"
                            )) %>% droplevels()
dim(df1)
# 769943     10

auto_overview <- df1 %>% 
  group_by(autoid) %>%
  summarise(percentage = n() / nrow(df1) * 100) %>% 
  mutate(percentage = as.integer(percentage)) 
## 13% noise

summary(df1)

summary(df1$autoid)
# BARBAR EPTNIL MYOBRA MYODAU MYOMYS MYONAT NYCNOC 
#   2918 447284    142   4079    375    127   2143 
#   NoID  Noise PIPNAT PIPPYG PLEAUR VESMUR 
#  38473 174248   6805  89365   2922   1062

### #write.csv(df1, file = file.path(output_today, "JudithSites_TotalAutoID.csv"))
# 12.08.2025

#What is the percentage of noise recorded across sites?
cm04 <- df1 %>% filter(site == "CM-04")  
cm06 <- df1 %>% filter(site == "CM-06")  
cm05 <- df1 %>% filter(site == "CM-05")  
cm23 <- df1 %>% filter(site == "CM-23")  
cm21 <- df1 %>% filter(site == "CM-21")  
cm42 <- df1 %>% filter(site == "CM-42")  
  
noiserat_cm04 <- cm04 %>% 
  group_by(autoid) %>%
  summarise(percentage = n() / nrow(cm04) * 100) %>% 
  mutate(percentage = as.integer(percentage)) 
## 13% noise

noiserat_cm06 <- cm06 %>% 
  group_by(autoid) %>%
  summarise(percentage = n() / nrow(cm06) * 100) %>% 
  mutate(percentage = as.integer(percentage)) 
## 27% noise

noiserat_cm05 <- cm05 %>% 
  group_by(autoid) %>%
  summarise(percentage = n() / nrow(cm05) * 100) %>% 
  mutate(percentage = as.integer(percentage)) 
## 45% noise

noiserat_cm23 <- cm23 %>% 
  group_by(autoid) %>%
  summarise(percentage = n() / nrow(cm23) * 100) %>% 
  mutate(percentage = as.integer(percentage)) 
## 96% noise

noiserat_cm21 <- cm21 %>% 
  group_by(autoid) %>%
  summarise(percentage = n() / nrow(cm21) * 100) %>% 
  mutate(percentage = as.integer(percentage)) 
## 21% noise

noiserat_cm42 <- cm42 %>% 
  group_by(autoid) %>%
  summarise(percentage = n() / nrow(cm42) * 100) %>% 
  mutate(percentage = as.integer(percentage)) 
## 14% noise


library(MoMAColors)

## Make a figure illustrating this 
barnoise <- ggplot(df1) + 
  geom_bar(aes(x= site, fill = autoid), position = "fill") +
  scale_fill_manual(name = "AutoID", values = moma.colors("Warhol", n = 13)) + 
  ylab("Proportion of recordings") + 
  xlab("Site") +
  theme(text = element_text(size = 25)) 
barnoise

ggsave(path = output_today, filename = "AllSites_Judith_Noise.tiff", width = 23, height = 14, device='tiff', dpi=300) 

## Look at overall recording period 
windows()
ggplot(df1) + 
  geom_point(aes(x = DATE.12, y = site), 
             color = "orange", alpha = 0.5, size = 3) +
    xlab("Date in season") + ylab(" ") +
  ggtitle("Recording activity") + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        text = element_text(size = 25),
        axis.line = element_line(colour = "black"))

#ggsave(path = output_today, filename = "BasicRecordingOverview.tiff", width = 23, height = 14, device='tiff', dpi=300) 

# My first instinct is that most recording across all sites happened between late July and early September


```


## Remove noise and take another look 
```{r}
levels(df1$autoid)
summary(df1$autoid)
# 174248 noise files that we will remove. 

df2 <- df1 %>% dplyr::filter(autoid != "Noise") %>% droplevels()
dim(df2)
# 595695  obs of  10 vars 
# 769943-174248 = 595695 - good! 

summary(df2$autoid)

## Simple dataset for easily making exploratory figures 
#write.csv(df2, file = file.path(output_today, "JuditheData_AutoId_NoNoise_SimpleColumns.csv"))

## Now take a look on what the recording activity looks like 
ggplot(df2) + 
  geom_point(aes(x = DATE.12, y = site), 
             color = "turquoise", alpha = 0.5, size = 3) +
    xlab("Date in season") + ylab(" ") +
  ggtitle("Recording activity - Noise files removed") + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        text = element_text(size = 25),
        axis.line = element_line(colour = "black"))

#ggsave(path = output_today, filename = "BasicRecordingOverview_noNoise.tiff", width = 23, height = 14, device='tiff', dpi=300) 


## And just because I am curious 
ggplot(df2 %>% filter(autoid == "PIPNAT") %>% droplevels()) + 
  geom_point(aes(x = DATE.12, y = site), 
             color = "coral", alpha = 0.5, size = 3) +
    xlab("Date in season") + ylab(" ") +
  ggtitle("Recording activity - auotid Nathusius Pip") + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        text = element_text(size = 25),
        axis.line = element_line(colour = "black"))

#ggsave(path = output_today, filename = "BasicRecordingOverview_PNATonly.tiff", width = 23, height = 14, device='tiff', dpi=300) 

### Now add a subset of random noise files from reach site for Benedikte to also check 

table(df1$site, df1$autoid)
# Randomly select 500 Noise files from each site for her to validate


df1$month <-  as.factor(format(df1$DATE, "%B") ) # Full month name (e.g., "January")
# summary(df1$month)
#    August      July      June   October September 
#    333835    238957     52375     10162    134614 

table(df1$site, df1$month)
  #       August  July  June October September
  # CM-04  95936 35917 21135    1326     24931
  # CM-05  24437 25360 14770       0     22091
  # CM-06  75074 28628 12514    7334     37926
  # CM-21  51280 52504  3956     365     28960
  # CM-23  41735 36901     0     177     10989
  # CM-42  45373 59647     0     960      9717

## The only months that we have recordings for all sites are July, August, and September. 

DF <- df1 %>% 
  dplyr::filter(month %in% c("July", "August", "September")) %>% 
  droplevels()
# 707406 obs 11 vars 

## Now with all BBAR, PAUR, NNOC, VMUR, PNAT and Myotis species combined 
levels(df1$autoid)

sub1 <- DF %>% filter(
  autoid %in% c(
    "BARBAR", "PLEAUR", "VESMUR", "NYCNOC", 
    "MYOBRA", "MYODAU", "MYOMYS", "MYONAT",
    "PIPNAT"))
# 19179 obs of 11 vars 

## Overview of soprano pip autoid recordings
ppyg <- DF %>% 
  dplyr::filter(autoid %in% c("PIPPYG")) %>% 
  dplyr::filter(month %in% c("July", "August", "September")) %>%
  droplevels()

ggplot(ppyg) + 
  geom_bar(aes(x = month), stat = "count", fill = "orange") + 
  facet_wrap(~site) + ggtitle("Soprano pips autoid")

## Overview of northern bat autoid recordings
epni <- DF %>% 
  dplyr::filter(autoid %in% c("EPTNIL")) %>% 
  dplyr::filter(month %in% c("July", "August", "September")) %>%
  droplevels() 

ggplot(epni) + 
  geom_bar(aes(x = month), stat = "count", fill = "turquoise") +
  facet_wrap(~site) + ggtitle("Northern bats autoid")

# potential subset of northern bats 
sub_EPTNIL <- DF %>% 
  dplyr::filter(autoid == "EPTNIL") %>%
  droplevels() %>%
  group_by(site, month) %>% slice_sample(n = 400) %>%
  ungroup() %>%
  arrange(site, month)
dim(sub_EPTNIL)
# 7200   11

# potential subset of soprano pips 
sub_PIPPYG <- DF %>% 
  dplyr::filter(autoid == "PIPPYG") %>%
  droplevels() %>%
  group_by(site, month) %>% slice_sample(n = 200) %>%
  ungroup() %>%
  arrange(site, month)
dim(sub_PIPPYG)
# 3600   11    

## NoID subset 
noid_sub <- DF %>% 
  filter(autoid == "NoID") %>% 
  droplevels() %>% 
  group_by(site, month) %>% slice_sample(n=300) %>% 
  ungroup() 
dim(noid_sub)
# 5400   11

## Noise subset 
noise_sub <- DF %>% 
  filter(autoid == "Noise") %>% 
  droplevels() %>% 
  group_by(site, month) %>% slice_sample(n=100) %>% 
  ungroup() 
dim(noise_sub)
# 1800   11


# How many observations all together? 
dim(sub1) + dim(sub_PIPPYG) + 
dim(sub_EPTNIL) + dim(noid_sub) + dim(noise_sub) 
# 37179 observations


## Now add together so you can re-create the file paths 
pt1 <- merge(sub1, sub_PIPPYG, all = TRUE)
# 26379 obs of 11 vars 
dim(sub1) + dim(sub_PIPPYG) # checks out 

pt2 <- merge(pt1, sub_EPTNIL, all = TRUE)
# 29979 obs of 11 vars 
dim(pt1) + dim(sub_EPTNIL) # checks out 

pt3 <- merge(pt2, noid_sub, all = TRUE) 
# 35379 obs of 11 vars
dim(pt2) + dim(noid_sub) # checks out 

pt4 <- merge(pt3, noise_sub, all = TRUE) 
dim(pt3) + dim(noise_sub) # checks out! 

dim(pt4)

summary(pt4)
duplicates <- pt4 %>%
  group_by(filename) %>%
  filter(n() > 1) %>%
  ungroup()

print(duplicates)
summary(pt4$autoid)
# BARBAR EPTNIL MYOBRA MYODAU MYOMYS MYONAT 
#   2436   3600    142   3929    374    123 
# NYCNOC   NoID  Noise PIPNAT PIPPYG PLEAUR 
#   2052   5400   1800   6239   7200   2897 
# VESMUR 
#    987 

summary(pt4$site)
# CM-04 CM-05 CM-06 CM-21 CM-23 CM-42 
#  3732  3961  8022  7878  4981  8605 

table(pt4$site, pt4$month)
  #       August July September
  # CM-04   1382 1074      1276
  # CM-05   1294 1250      1417
  # CM-06   3004 1886      3132
  # CM-21   2427 1563      3888
  # CM-23   1662 1462      1857
  # CM-42   4556 2169      1880

# The numbers of rows add up! 
## Explore what this looks like across the sites and months 
ggplot(pt4) + 
  geom_bar(aes(x=month, fill = autoid), stat = "count") + 
  facet_wrap(~site) + 
  scale_fill_manual(name = "AutoID", 
  values = moma.colors("Warhol", n = 13)) + 
  ylab("N recordings per month") + 
  xlab("Site") +
  theme_minimal(base_size = 16) + 
  ggtitle("2024") 

#write.csv(pt4, file = file.path(output_today, "example_JudithSubset_attempt1.csv"))
# 12.08.2025  

```