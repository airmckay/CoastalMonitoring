---
title: "DataSubsetting_Judith"
output: html_document
date: "2025-08-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Prepare and overview automatically classified bat acoustic data for Judith Feldhaus's Masters thesis. 

## Import the full dataset from Maris of all the 2024 CM observations combined and subset for Judith's sites

## THen try to further subset based on the measures that Maris and I agreed on 

Check all categories: 
VMUR, NNOC, PAUR, BBAR
 
Check 50% 
Myotis all together
 
Check 10%
PPYG, PNAT
 
Check 5% 
EPNI
 
NoID and Noise subset - block number per site. Will determine exact value later.

Subset by site by month within year
 
Aim for approximately 12500 recordings per site
 
6 sites in total 
Sites: CM-04, CM-06, CM-05, CM-23, CM-21, CM-42
 


## Prepare workspace
```{r}
library(data.table)
library(tidyverse)
library(beepr)
library(lubridate)
library(purrr)
library(janitor)
library(renv)
library(stringr)
library(beepr)
library(randomcoloR)
library(wesanderson)
library(leaflegend)
library(osmdata)
library(MetBrewer)
library(colorBlindness)
library(colorblindcheck)
library(MoMAColors)
library(stringdist)

getwd()
# "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/GitHubLink/CoastalMonitoring/CoastalMonitoring"

## Setup output directory 
output <-"C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/CoastalMonitoring/Analyses/Outputs/Reed" # where you want to save your data

file.name <- "OverviewProcessedBatData_Judith2025"

todays_date <- Sys.Date()
 
dir.name <- str_c(output,"/", file.name, "_", todays_date)
dir.name
 
output_today <- dir.name
output_today

dir.create(output_today)
output_today
# "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/CoastalMonitoring/Analyses/Outputs/Reed/OverviewProcessedBatData_Judith2025_2025-08-12"

```

## Subset and tidy the dataset for only Judith's sites
Sites: CM-04, CM-06, CM-05, CM-23, CM-21, CM-42

```{r}
input <- read_csv("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/CoastalMonitoring/Analyses/Outputs/Reed/2024CombineCSVs_2025-09-16/JudithSites2024_all.csv")

dim(input)
# 769409     47
names(input)

## Housekeeping
df1 <- input %>% 
  mutate(autoid = factor(AUTO.ID.), 
         site = factor(site),
         filename = OUT.FILE.FS) %>% 
  dplyr::select(FOLDER, filename, 
                DATE, TIME, HOUR,
                DATE.12, TIME.12, HOUR.12,
                autoid, site
                ) %>% droplevels()
dim(df1)
# 769409     10

auto_overview <- df1 %>% 
  group_by(autoid) %>%
  summarise(percentage = n() / nrow(df1) * 100) %>% 
  mutate(percentage = as.integer(percentage)) 
## 22% noise

summary(df1)

summary(df1$autoid)
# BARBAR EPTNIL MYOBRA MYODAU MYOMYS MYONAT NYCNOC   NoID 
#   2918 447274    142   4079    375    127   2143  38471 
#  Noise PIPNAT PIPPYG PLEAUR VESMUR 
# 173744   6805  89347   2922   1062

#write.csv(df1, file = file.path(output_today, "JudithSites_TotalAutoID.csv"))
# 16.09.2025

#What is the percentage of noise recorded across sites?
cm04 <- df1 %>% filter(site == "CM-04")  
cm06 <- df1 %>% filter(site == "CM-06")  
cm05 <- df1 %>% filter(site == "CM-05")  
cm23 <- df1 %>% filter(site == "CM-23")  
cm21 <- df1 %>% filter(site == "CM-21")  
cm42 <- df1 %>% filter(site == "CM-42")  
  
# noiserat_cm04 <- cm04 %>% 
#   group_by(autoid) %>%
#   summarise(percentage = n() / nrow(cm04) * 100) %>% 
#   mutate(percentage = as.integer(percentage)) 
## 13% noise
# 
# noiserat_cm05 <- cm05 %>% 
#   group_by(autoid) %>%
#   summarise(percentage = n() / nrow(cm05) * 100) %>% 
#   mutate(percentage = as.integer(percentage)) 
## 48% noise

# noiserat_cm06 <- cm06 %>% 
#   group_by(autoid) %>%
#   summarise(percentage = n() / nrow(cm06) * 100) %>% 
#   mutate(percentage = as.integer(percentage)) 
## 27% noise

# noiserat_cm23 <- cm23 %>% 
#   group_by(autoid) %>%
#   summarise(percentage = n() / nrow(cm23) * 100) %>% 
#   mutate(percentage = as.integer(percentage)) 
## 21% noise

# noiserat_cm21 <- cm21 %>% 
#   group_by(autoid) %>%
#   summarise(percentage = n() / nrow(cm21) * 100) %>% 
#   mutate(percentage = as.integer(percentage)) 
## 20% noise

# noiserat_cm42 <- cm42 %>% 
#   group_by(autoid) %>%
#   summarise(percentage = n() / nrow(cm42) * 100) %>% 
#   mutate(percentage = as.integer(percentage)) 
## 14% noise


## Make a figure illustrating this 
# barnoise <- ggplot(df1) + 
#   geom_bar(aes(x= site, fill = autoid), position = "fill") +
#   scale_fill_manual(name = "AutoID", values = moma.colors("Warhol", n = 13)) + 
#   ylab("Proportion of recordings") + 
#   xlab("Site") +
#   theme(text = element_text(size = 25)) 
# barnoise

#ggsave(path = output_today, filename = "AllSites_Judith_Noise.tiff", width = 23, height = 14, device='tiff', dpi=300) 

## Look at overall recording period 
 windows()
ggplot(df1) +
  geom_point(aes(x = DATE.12, y = site),
             color = "orange", alpha = 0.5, size = 3) +
    xlab("Date in season") + ylab(" ") +
  ggtitle("Recording activity") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 25),
        axis.line = element_line(colour = "black"))
# 
# ggsave(path = output_today, filename = "BasicRecordingOverview.tiff", width = 23, height = 14, device='tiff', dpi=300) 

# My first instinct is that most recording across all sites happened between late July and early September


```


## Remove noise and take another look 
```{r}
levels(df1$autoid)
summary(df1$autoid)
# 174248 noise files that we will remove. 

df2 <- df1 %>% dplyr::filter(autoid != "Noise") %>% droplevels()
dim(df2)
# 595665  obs of  10 vars 
769409-173744 # 595665, good! 

summary(df2$autoid)
## Simple dataset for easily making exploratory figures 
#write.csv(df2, file = file.path(output_today, "JuditheData_AutoId_NoNoise_SimpleColumns.csv"))

## Now take a look on what the recording activity looks like 
# ggplot(df2) + 
#   geom_point(aes(x = DATE.12, y = site), 
#              color = "turquoise", alpha = 0.5, size = 3) +
#     xlab("Date in season") + ylab(" ") +
#   ggtitle("Recording activity - Noise files removed") + 
#   theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(), 
#         text = element_text(size = 25),
#         axis.line = element_line(colour = "black"))

#ggsave(path = output_today, filename = "BasicRecordingOverview_noNoise.tiff", width = 23, height = 14, device='tiff', dpi=300) 


## And just because I am curious 
# ggplot(df2 %>% filter(autoid == "PIPNAT") %>% droplevels()) + 
#   geom_point(aes(x = DATE.12, y = site), 
#              color = "coral", alpha = 0.5, size = 3) +
#     xlab("Date in season") + ylab(" ") +
#   ggtitle("Recording activity - auotid Nathusius Pip") + 
#   theme(panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank(),
#         panel.background = element_blank(), 
#         text = element_text(size = 25),
#         axis.line = element_line(colour = "black"))

#ggsave(path = output_today, filename = "BasicRecordingOverview_PNATonly.tiff", width = 23, height = 14, device='tiff', dpi=300) 

### Now add a subset of random noise files from reach site for Benedikte to also check 

table(df1$site, df1$autoid)
# Randomly select 500 Noise files from each site for her to validate


df1$month <-  as.factor(format(df1$DATE, "%B") ) # Full month name (e.g., "January")
 summary(df1$month)
   # August      July      June   October September 
   # 333567    238803     52342     10158    134539 

table(df1$site, df1$month)
  #       August  July  June October September
  # CM-04  95869 35888 21126    1325     24913
  # CM-05  24421 25344 14760       0     22085
  # CM-06  74990 28602 12502    7331     37898
  # CM-21  51239 52481  3954     365     28947
  # CM-23  41710 36873     0     177     10986
  # CM-42  45338 59615     0     960      9710

## The only months that we have recordings for all sites are July, August, and September. 
DF <- df1 %>% 
  dplyr::filter(month %in% c("July", "August", "September")) %>% 
  droplevels()
dim(DF)
# 706909 obs 11 vars 

## Now with all BBAR, PAUR, NNOC, VMUR, PNAT and Myotis species combined 
levels(df1$autoid)

sub1 <- DF %>% filter(
  autoid %in% c(
    "BARBAR", "PLEAUR", "VESMUR", "NYCNOC", 
    "MYOBRA", "MYODAU", "MYOMYS", "MYONAT",
    "PIPNAT"))
# 19179 obs of 11 vars 

## Overview of soprano pip autoid recordings
ppyg <- DF %>% 
  dplyr::filter(autoid %in% c("PIPPYG")) %>% 
  dplyr::filter(month %in% c("July", "August", "September")) %>%
  droplevels()

ggplot(ppyg) + 
  geom_bar(aes(x = month), stat = "count", fill = "orange") + 
  facet_wrap(~site) + ggtitle("Soprano pips autoid")

## Overview of northern bat autoid recordings
epni <- DF %>% 
  dplyr::filter(autoid %in% c("EPTNIL")) %>% 
  dplyr::filter(month %in% c("July", "August", "September")) %>%
  droplevels() 

ggplot(epni) + 
  geom_bar(aes(x = month), stat = "count", fill = "turquoise") +
  facet_wrap(~site) + ggtitle("Northern bats autoid")

# potential subset of northern bats 
sub_EPTNIL <- DF %>% 
  dplyr::filter(autoid == "EPTNIL") %>%
  droplevels() %>%
  group_by(site, month) %>% slice_sample(n = 400) %>%
  ungroup() %>%
  arrange(site, month)
dim(sub_EPTNIL)
# 7200   11

# potential subset of soprano pips 
sub_PIPPYG <- DF %>% 
  dplyr::filter(autoid == "PIPPYG") %>%
  droplevels() %>%
  group_by(site, month) %>% slice_sample(n = 200) %>%
  ungroup() %>%
  arrange(site, month)
dim(sub_PIPPYG)
# 3600   11    

## NoID subset 
noid_sub <- DF %>% 
  filter(autoid == "NoID") %>% 
  droplevels() %>% 
  group_by(site, month) %>% slice_sample(n=300) %>% 
  ungroup() 
dim(noid_sub)
# 5400   11

## Noise subset 
noise_sub <- DF %>% 
  filter(autoid == "Noise") %>% 
  droplevels() %>% 
  group_by(site, month) %>% slice_sample(n=100) %>% 
  ungroup() 
dim(noise_sub)
# 1800   11

# How many observations all together? 
dim(sub1) + dim(sub_PIPPYG) + 
dim(sub_EPTNIL) + dim(noid_sub) + dim(noise_sub) 
# 37179 observations


## Now add together so you can re-create the file paths 
pt1 <- merge(sub1, sub_PIPPYG, all = TRUE)
# 22779  obs of 11 vars 
dim(sub1) + dim(sub_PIPPYG) # checks out 

pt2 <- merge(pt1, sub_EPTNIL, all = TRUE)
# 29979 obs of 11 vars 
dim(pt1) + dim(sub_EPTNIL) # checks out 

pt3 <- merge(pt2, noid_sub, all = TRUE) 
# 35379 obs of 11 vars
dim(pt2) + dim(noid_sub) # checks out 

pt4 <- merge(pt3, noise_sub, all = TRUE) 
# 31779 obs of 11 vars
dim(pt3) + dim(noise_sub) # checks out! 


summary(pt4)

#check for duplicats
duplicates <- pt4 %>%
  group_by(filename) %>%
  filter(n() > 1) %>%
  ungroup() # none - good! 


summary(pt4$autoid)
# BARBAR EPTNIL MYOBRA MYODAU MYOMYS MYONAT NYCNOC   NoID  Noise 
#   2436   7200    142   3929    374    123   2052   5400   1800 
# PIPNAT PIPPYG PLEAUR VESMUR 
#   6239   3600   2897    987 

summary(pt4$site)
# CM-04 CM-05 CM-06 CM-21 CM-23 CM-42 
#  3732  3961  8022  7878  4981  8605 

table(pt4$site, pt4$month)
  #       August July September
  # CM-04   1382 1074      1276
  # CM-05   1294 1250      1417
  # CM-06   3004 1886      3132
  # CM-21   2427 1563      3888
  # CM-23   1662 1462      1857
  # CM-42   4556 2169      1880

# The numbers of rows add up! 
## Explore what this looks like across the sites and months 
ggplot(pt4) + 
  geom_bar(aes(x=month, fill = autoid), stat = "count") + 
  facet_wrap(~site) + 
  scale_fill_manual(name = "AutoID", 
  values = moma.colors("Warhol", n = 13)) + 
  ylab("N recordings per month") + 
  xlab("Site") +
  theme_minimal(base_size = 16) + 
  ggtitle("2024") 

 
dim(pt4)
# 37179    11

#write.csv(pt4, file = file.path(output_today, "example_JudithSubset_attempt3.csv"))
# 07.10.2025 


```

## Recreate file paths 
```{r}
fp <- read_csv("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/BatLab Norway/Projects/CoastalMonitoring/Analyses/Outputs/Reed/FixingFilepaths_2025-10-07/cleaned_output_filepaths_CM2024.csv",      col_types = cols(...1 = col_skip()))
fp$all_dirs <- factor(fp$all_dirs)
# 296 rows 


## Combine back filepath info 
dx <- input %>% 
  mutate(filename = OUT.FILE.FS) %>% 
  dplyr::select(filename, OUTDIR, FOLDER)


pt5 <- left_join(pt4, dx) 
summary(pt5)
head(pt5)

table(pt5$autoid, pt5$site)

pt5$path <- paste0(pt5$OUTDIR, "/", pt5$FOLDER, "/")
#head(pt5$path)

pt5$path1 <- gsub("\\\\", "/", pt5$path)

pt5$path1 <- factor(pt5$path1)
levels(pt5$path1)


### Start the tedious process of fixing things 
pt5$path2 <- factor(gsub("C:/TemporaryDatastorage", "P:/SW_CoastalMonitoring/Data_collection_2024", pt5$path1))
levels(pt5$path2)

## CM-04 and CM-05 are going to be the most complicated to fix - so lets extract those alone from the fp object
#fp1 <- fp %>% filter(str_detect(all_dirs, "CM-04|CM-05" ) ) 
fp04 <- fp %>% filter(str_detect(all_dirs, "CM-04")) %>% droplevels() # 10 obs
fp05 <- fp %>% filter(str_detect(all_dirs, "CM-05")) %>% droplevels() # 8 obs 

levels(fp04$all_dirs)
#  [1] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_06.09.2024_CM-04/Data"      
#  [2] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_06.09.2024_CM-04/Data/NOISE"
#  [3] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_09.10.2024_CM-04/Data"      
#  [4] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_09.10.2024_CM-04/Data/NOISE"
#  [5] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_18.07.2024_CM-04/Data"      
#  [6] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_18.07.2024_CM-04/Data/NOISE"
#  [7] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_24.08.2024_CM-04/Data"      
#  [8] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_24.08.2024_CM-04/Data/NOISE"
#  [9] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_25.07.2024_CM-04/Data"      
# [10] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_25.07.2024_CM-04/Data/NOISE"

levels(fp05$all_dirs)
# [1] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_01.10.2024_CM-05/Data"      
# [2] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_01.10.2024_CM-05/Data/NOISE"
# [3] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_02.08.2024_CM-05/Data"      
# [4] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_02.08.2024_CM-05/Data/NOISE"
# [5] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_19.07.2024_CM-05/Data"      
# [6] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_19.07.2024_CM-05/Data/NOISE"
# [7] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_24.08.2024_CM-05/Data"      
# [8] "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_24.08.2024_CM-05/Data/NOISE"

pt5$path3 <- factor(gsub("D:/06.09.2024_CM-04/Data/", "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_06.09.2024_CM-04/Data/", pt5$path2)) 
levels(pt5$path3)

pt5$path4 <- factor(gsub("D:/09.10.2024_C-04/Data/", "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_09.10.2024_CM-04/Data/", pt5$path3)) 
levels(pt5$path4)

pt5$path5 <- factor(gsub("D:/18.07.2024_CM_04/Data/", "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_18.07.2024_CM_04/Data/", pt5$path4))
levels(pt5$path5)

pt5$path6 <- factor(gsub("D:/24.08.2024_CM-04/Data/", "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_24.08.2024_CM-04/Data/", pt5$path5))
levels(pt5$path6)

pt5$path7 <- factor(gsub("D:/25.07.2024_CM-04/Data/", "P:/SW_CoastalMonitoring/Data_collection_2024/CM-04/WAV/KPRO_V1_25.07.2024_CM-04/Data/", pt5$path6))
levels(pt5$path7)

pt5$path8 <- factor(gsub("D:/CM/01.10.2024_CM-05/Data/", "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_01.10.2024_CM-05/Data/", pt5$path7)) 
levels(pt5$path8)

pt5$path9 <- factor(gsub("D:/CM/02.08.2024_CM-05/Data/", "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_02.08.2024_CM-05/Data/", pt5$path8))
levels(pt5$path9)

pt5$path10 <- factor(gsub("D:/CM/19.07.2024_CM-05/Data/", "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_19.07.2024_CM-05/Data/", pt5$path9)) 
levels(pt5$path10)

pt5$path11 <- factor(gsub("D:/CM/24.08.2024_CM-05/Data/", "P:/SW_CoastalMonitoring/Data_collection_2024/CM-05/WAV/KPRO_V1_24.08.2024_CM-05/Data/", pt5$path10)) 
levels(pt5$path11)

pt5$path12 <- factor(gsub("Data/Data/", "Data/", pt5$path11)) 
pt5$path12 <- factor(pt5$path12)
levels(pt5$path12)
# Nice and tidy now!! 


### Now try to copy over one site at a time. NOTE! 
## We now know that Noise files for CM-04 and CM-05 had a Noise subdirectory. So now we have to include that in the total directory as well. 

cm04.noise <- pt5 %>% filter(site == "CM-04") %>% filter(autoid == "Noise") %>% droplevels()
# 300 noise files 
cm04.noise$fullpath <- paste0(cm04.noise$path12, "/NOISE/", cm04.noise$filename)
head(cm04.noise$fullpath)

cm04.bats<- pt5 %>% filter(site == "CM-04") %>% filter(autoid != "Noise") %>% droplevels()
summary(cm04.bats$autoid)
# BARBAR EPTNIL MYOBRA MYODAU MYONAT NYCNOC   NoID PIPNAT PIPPYG PLEAUR VESMUR 
#    278   1200      1     33      4    121    900    102    600    166     27 
# 3432 files 

cm04.bats$fullpath <- paste0(cm04.bats$path12, "/", cm04.bats$filename)
head(cm04.bats$fullpath)

cm04.subset <- full_join(cm04.noise, cm04.bats)
# 3732 obs of 26 vars - good!
summary(cm04.subset)

cm04.subset1 <- cm04.subset %>% 
  select(filename, fullpath, 
                      DATE, TIME, HOUR, 
                      DATE.12, TIME.12, HOUR.12, 
                      autoid, site, month) %>% droplevels()
summary(cm04.subset1)

test <- unique(cm04.subset1$fullpath)
#3732 unique filepaths - good!

## Now try copying over CM-04 files... 
# CM-04 3732
cm04_files <- as.list(cm04.subset1$fullpath)
cm04_files_list <- unlist(cm04_files)



## This will take a while: 
file.copy(from = cm04_files_list,
            to = "P:/SW_CoastalMonitoring/Data_analysis_2024/MSc_Theses/Judith/CM-04_subset1")
  beep()
# 
  
#   summary(cm04$autoid)
# 
#   check <- cm04 %>% filter(autoid == "Noise") %>% droplevels()
#   
# check.better <- list.files("P:/SW_CoastalMonitoring/Data_analysis_2024/MSc_Theses/Judith/CM-04_Test")
# 
# checkthis <- data.frame(filename = check.better)
# checkthis1 <- data.frame(filename = cm04$filename) 
# checkthis2<- left_join(checkthis, cm04)
# summary(checkthis2$autoid)
## # None of these were noise files.. 
#beep()
  
  ## remember to also copy over metadata!! 

```

